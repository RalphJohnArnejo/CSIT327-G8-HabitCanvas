{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HabitCanvas | Tasks</title>

    <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>

<body>

<!-- NAVIGATION -->
<header class="top-nav">
    <div class="left">
        <img src="{% static 'habitcanvass.jpg' %}" class="logo-img">
        <span class="logo-text">HabitCanvas</span>
    </div>

    <div class="nav-center">
        <a href="#" class="nav-btn active"><i class="fa fa-list"></i> Tasks</a>
        <a href="/timer" class="nav-btn"><i class="fa fa-stopwatch"></i> Timer</a>
        <a href="/calendar" class="nav-btn"><i class="fa fa-calendar"></i> Calendar</a>
    </div>

    <div class="right">
        <a href="#" class="btn-logout">Logout</a>
    </div>
</header>

<!-- PAGE CONTENT -->
<div class="page-container">
    <div class="header-row">
        <div>
            <h2>My Tasks</h2>
            <p class="subtext">
                <span id="activeTaskCount">{{ active_count }}</span> active tasks
            </p>
        </div>
        <a href="#" class="btn-primary" id="openAddBtn">
            <i class="fa fa-plus"></i> Add new task
        </a>
    </div>

    <!-- FILTERS -->
    <div class="filters">
        <form method="GET" id="filterForm">
            <select name="sort" onchange="this.form.submit()">
                <option value="default" {% if request.GET.sort == 'default' or not request.GET.sort %}selected{% endif %}>Default</option>
                <option value="priority" {% if request.GET.sort == 'priority' %}selected{% endif %}>Priority</option>
            </select>

            <select name="category" onchange="this.form.submit()">
                <option value="" {% if not request.GET.category %}selected{% endif %}>All Categories</option>
                <option value="School" {% if request.GET.category == 'School' %}selected{% endif %}>School</option>
                <option value="Personal" {% if request.GET.category == 'Personal' %}selected{% endif %}>Personal</option>
                <option value="Work" {% if request.GET.category == 'Work' %}selected{% endif %}>Work</option>
            </select>

            <select name="difficulty" onchange="this.form.submit()">
                <option value="" {% if not request.GET.difficulty %}selected{% endif %}>All Difficulty</option>
                <option value="Easy" {% if request.GET.difficulty == 'Easy' %}selected{% endif %}>Easy</option>
                <option value="Medium" {% if request.GET.difficulty == 'Medium' %}selected{% endif %}>Medium</option>
                <option value="Hard" {% if request.GET.difficulty == 'Hard' %}selected{% endif %}>Hard</option>
            </select>
        </form>
    </div>

    <!-- TASK LIST -->
    <div class="task-list">
        <div id="active-tasks">
            {% for task in tasks %}
                {% if not task.completed %}
                    {% include "main/partials/task_card.html" with task=task %}
                {% endif %}
            {% endfor %}
        </div>

        <h3 class="completed-title">Completed Tasks</h3>
        <div id="completed-tasks">
            {% for task in tasks %}
                {% if task.completed %}
                    {% include "main/partials/task_card.html" with task=task %}
                {% endif %}
            {% endfor %}
        </div>
    </div>
</div>

<!-- ADD TASK MODAL -->
<div id="addModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Add New Task</h2>

        <form id="addTaskForm" method="POST" action="{% url 'add_task' %}">
            {% csrf_token %}

            <label>Task Title</label>
            <input type="text" name="title" id="title" required>

            <label>Category</label>
            <select name="category" id="category" required>
                <option value="School">School</option>
                <option value="Personal">Personal</option>
                <option value="Work">Work</option>
            </select>

            <label>Difficulty</label>
            <select name="difficulty" id="difficulty" required>
                <option value="Easy">Easy</option>
                <option value="Medium">Medium</option>
                <option value="Hard">Hard</option>
            </select>

            <label>Due Date</label>
            <input type="text" name="due_date" id="due_date" class="flatpickr">

            <label>Priority</label>
            <select name="priority" id="priority">
                <option value="0">Low</option>
                <option value="1">Medium</option>
                <option value="2">High</option>
            </select>

            <label class="calendar-checkbox">
                <input type="checkbox" name="add_to_calendar" value="1">
                <span>📅 Add to Calendar</span>
            </label>

            <button class="btn-primary">Add Task</button>
        </form>
    </div>
</div>

<!-- EDIT MODAL -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Edit Task</h2>

        <form id="editTaskForm" method="POST">{% csrf_token %}
            <label>Task Title</label>
            <input type="text" id="edit_title" name="title" required>

            <label>Category</label>
            <select id="edit_category" name="category" required>
                <option value="School">School</option>
                <option value="Personal">Personal</option>
                <option value="Work">Work</option>
            </select>

            <label>Difficulty</label>
            <select id="edit_difficulty" name="difficulty" required>
                <option value="Easy">Easy</option>
                <option value="Medium">Medium</option>
                <option value="Hard">Hard</option>
            </select>

            <label>Due Date</label>
            <input type="text" id="edit_due_date" name="due_date" class="flatpickr">

            <label>Priority</label>
            <select id="edit_priority" name="priority">
                <option value="0">Low</option>
                <option value="1">Medium</option>
                <option value="2">High</option>
            </select>

            <button class="btn-primary">Save Changes</button>
        </form>
    </div>
</div>

<!-- LOGOUT MODAL -->
<div id="logoutModal" class="modal">
    <div class="modal-content logout-box">
        <h2>Goodbye 👋</h2>
        <p>Are you sure you want to log out?</p>

        <button id="btnConfirmLogout" class="btn-danger">Logout</button>
        <button id="btnCancelLogout" class="btn-secondary">Stay logged in</button>
    </div>
</div>

<!-- JAVASCRIPT -->
<script>

/* COOKIE HELPER */
function getCookie(name) {
    let cookieValue = null;
    document.cookie.split(";").forEach(cookie => {
        cookie = cookie.trim();
        if (cookie.startsWith(name + "=")) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        }
    });
    return cookieValue;
}

/* COUNT ACTIVE TASKS */
function refreshActiveCount() {
    document.getElementById("activeTaskCount").textContent =
        document.querySelectorAll("#active-tasks .task-card").length;
}

/* SORT BY PRIORITY */
function sortTasksByPriority() {
    const list = document.getElementById("active-tasks");
    [...list.children]
        .sort((a, b) => Number(b.dataset.priority) - Number(a.dataset.priority))
        .forEach(task => list.appendChild(task));
}

/* ----------------------
   MODAL HANDLING
 ---------------------- */
const addModal = document.getElementById("addModal");
const editModal = document.getElementById("editModal");
const logoutModal = document.getElementById("logoutModal");

document.getElementById("openAddBtn").onclick = e => {
    e.preventDefault();
    addModal.style.display = "block";
};

addModal.querySelector(".close").onclick = () => addModal.style.display = "none";
editModal.querySelector(".close").onclick = () => editModal.style.display = "none";

/* CLICK OUTSIDE TO CLOSE */
window.onclick = e => {
    if (e.target === addModal) addModal.style.display = "none";
    if (e.target === editModal) editModal.style.display = "none";
    if (e.target === logoutModal) logoutModal.style.display = "none";
};

/* ----------------------
   EDIT TASK POPULATION
 ---------------------- */
function openEditModal(btn) {
    const id = btn.dataset.id;
    document.getElementById("edit_title").value = btn.dataset.title;
    document.getElementById("edit_category").value = btn.dataset.category;
    document.getElementById("edit_difficulty").value = btn.dataset.difficulty;
    document.getElementById("edit_priority").value = btn.dataset.priority;

    editCalendar.setDate(btn.dataset.due);

    document.getElementById("editTaskForm").action = `/tasks/edit/${id}/`;
    editModal.style.display = "block";
}

/* ----------------------
   LOGOUT LOGIC
 ---------------------- */
document.querySelector(".btn-logout").onclick = e => {
    e.preventDefault();
    logoutModal.style.display = "flex";
};

document.getElementById("btnCancelLogout").onclick = () =>
    logoutModal.style.display = "none";

document.getElementById("btnConfirmLogout").onclick = () =>
    window.location.href = "{% url 'logout' %}";


/* ----------------------
   FLATPICKR INIT
 ---------------------- */
let addCalendar, editCalendar;

document.addEventListener("DOMContentLoaded", function () {
    addCalendar = flatpickr("#due_date", {
        minDate: "today",
        dateFormat: "Y-m-d"
    });

    editCalendar = flatpickr("#edit_due_date", {
        minDate: "today",
        dateFormat: "Y-m-d"
    });
});

/* ----------------------
   SUBTASK SYSTEM
 ---------------------- */
function loadSubtasks(taskId) {
    fetch(`/tasks/${taskId}/subtasks/`, {
        headers: { "X-Requested-With": "XMLHttpRequest" }
    })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                updateSubtaskUI(taskId, data.subtasks, data.progress);
            }
        });
}

function addSubtask(taskId, title, inputEl) {
    const fd = new FormData();
    fd.append("title", title);

    fetch(`/tasks/${taskId}/subtasks/add/`, {
        method: "POST",
        body: fd,
        headers: { "X-CSRFToken": getCookie("csrftoken") }
    })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const list = document.querySelector(
                    `.subtask-list[data-task-id="${taskId}"]`
                );

                const li = document.createElement("li");
                li.className = "subtask-item";
                li.dataset.subtaskId = data.subtask_id;

                li.innerHTML = `
                    <label class="subtask-checkbox">
                        <input type="checkbox" data-subtask-id="${data.subtask_id}">
                        <span>${data.title}</span>
                    </label>
                    <button class="subtask-delete-btn" data-subtask-id="${data.subtask_id}">
                        <i class="fa fa-times"></i>
                    </button>`;

                list.appendChild(li);
                inputEl.value = "";
                updateSubtaskProgress(taskId, data.progress);
                attachTaskEvents();
            }
        });
}

function toggleSubtask(subtaskId, checkbox) {
    fetch(`/subtasks/${subtaskId}/toggle/`, {
        method: "POST",
        headers: { "X-CSRFToken": getCookie("csrftoken") }
    })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const li = checkbox.closest(".subtask-item");
                const title = li.querySelector("span");

                li.classList.toggle("completed", data.completed);
                title.classList.toggle("crossed", data.completed);

                const taskId = checkbox.closest(".task-card").dataset.id;
                updateSubtaskProgress(taskId, data.progress);
            }
        });
}

function deleteSubtask(subtaskId, btn) {
    fetch(`/subtasks/${subtaskId}/delete/`, {
        method: "POST",
        headers: { "X-CSRFToken": getCookie("csrftoken") }
    })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const li = btn.closest(".subtask-item");
                const taskId = btn.closest(".task-card").dataset.id;

                li.remove();
                updateSubtaskProgress(taskId, data.progress);
            }
        });
}

function updateSubtaskUI(taskId, subtasks, progress) {
    const list = document.querySelector(`.subtask-list[data-task-id="${taskId}"]`);
    list.innerHTML = "";

    subtasks.forEach(s => {
        const li = document.createElement("li");
        li.className = `subtask-item ${s.completed ? "completed" : ""}`;
        li.dataset.subtaskId = s.id;

        li.innerHTML = `
            <label class="subtask-checkbox">
                <input type="checkbox" data-subtask-id="${s.id}" ${s.completed ? "checked" : ""}>
                <span class="${s.completed ? "crossed" : ""}">${s.title}</span>
            </label>
            <button class="subtask-delete-btn" data-subtask-id="${s.id}">
                <i class="fa fa-times"></i>
            </button>`;

        list.appendChild(li);
    });

    updateSubtaskProgress(taskId, progress);
    attachTaskEvents();
}

function updateSubtaskProgress(taskId, progress) {
    const fill = document.querySelector(
        `.subtask-progress-fill[data-task-id="${taskId}"]`
    );
    const txt = document.querySelector(
        `.subtask-progress-text[data-task-id="${taskId}"]`
    );
    const badge = document.querySelector(
        `.subtask-count[data-task-id="${taskId}"]`
    );

    if (fill) fill.style.width = `${progress.percent}%`;
    if (txt) txt.textContent = `${progress.completed}/${progress.total} completed`;
    if (badge)
        badge.textContent =
            progress.total > 0 ? `${progress.completed}/${progress.total}` : "";
}

/* ----------------------
   ATTACH EVENT HANDLERS
 ---------------------- */
function attachTaskEvents() {
    document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.onclick = () => openEditModal(btn);
    });

    document.querySelectorAll(".complete-btn, .delete-btn").forEach(btn => {
        btn.onclick = e => {
            e.preventDefault();
            const id = btn.dataset.id;
            const isComplete = btn.classList.contains("complete-btn");

            fetch(
                isComplete
                    ? `/tasks/toggle_complete/${id}/`
                    : `/tasks/delete/${id}/`,
                {
                    method: "POST",
                    headers: { "X-CSRFToken": getCookie("csrftoken") }
                }
            )
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        if (isComplete) {
                            const card = btn.closest(".task-card");

                            if (data.completed) {
                                document.getElementById("completed-tasks").appendChild(card);
                                card.classList.add("completed");
                            } else {
                                document.getElementById("active-tasks").appendChild(card);
                                card.classList.remove("completed");
                                sortTasksByPriority();
                            }
                            refreshActiveCount();
                        } else {
                            btn.closest(".task-card").remove();
                            refreshActiveCount();
                        }
                    }
                });
        };
    });

    document.querySelectorAll(".favorite-btn").forEach(btn => {
        btn.onclick = () => {
            fetch(`/tasks/toggle_favorite/${btn.dataset.id}/`, {
                method: "POST",
                headers: { "X-CSRFToken": getCookie("csrftoken") }
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        btn.querySelector("i").classList.toggle("starred", data.favorite);
                    }
                });
        };
    });

    document.querySelectorAll(".subtask-toggle-btn").forEach(btn => {
        btn.onclick = () => {
            const taskId = btn.dataset.id;
            const section = btn.closest(".task-card").querySelector(".subtasks-section");

            if (section.style.display === "none") {
                section.style.display = "block";
                loadSubtasks(taskId);
            } else {
                section.style.display = "none";
            }
        };
    });

    document.querySelectorAll(".add-subtask-btn").forEach(btn => {
        btn.onclick = () => {
            const taskId = btn.dataset.taskId;
            const input = btn.parentElement.querySelector(".subtask-input");
            const value = input.value.trim();

            if (value) {
                addSubtask(taskId, value, input);
            }
        };
    });

    document.querySelectorAll(".subtask-input").forEach(input => {
        input.onkeypress = e => {
            if (e.key === "Enter") {
                e.preventDefault();
                const taskId = input.dataset.taskId;
                if (input.value.trim()) {
                    addSubtask(taskId, input.value.trim(), input);
                }
            }
        };
    });

    document.querySelectorAll(".subtask-checkbox input").forEach(box => {
        box.onchange = () => toggleSubtask(box.dataset.subtaskId, box);
    });

    document.querySelectorAll(".subtask-delete-btn").forEach(btn => {
        btn.onclick = () => deleteSubtask(btn.dataset.subtaskId, btn);
    });
}

attachTaskEvents();
refreshActiveCount();
sortTasksByPriority();

</script>
</body>
</html>
