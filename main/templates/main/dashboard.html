{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HabitCanvas | Tasks</title>

    <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>

<body>

<!-- NAVIGATION -->
<header class="top-nav">
    <div class="left">
        <img src="{% static 'habitcanvass.jpg' %}" class="logo-img">
        <span class="logo-text">HabitCanvas</span>
    </div>

    <div class="nav-center">
        <a href="#" class="nav-btn active"><i class="fa fa-list"></i> Tasks</a>
        <a href="/timer" class="nav-btn"><i class="fa fa-stopwatch"></i> Timer</a>
        <a href="/calendar" class="nav-btn"><i class="fa fa-calendar"></i> Calendar</a>
    </div>

    <div class="right">
        <a href="#" class="btn-logout" id="openLogout">Logout</a>
    </div>
</header>

<!-- PAGE CONTENT -->
<div class="page-container">
    <div class="header-row">
        <div>
            <h2>My Tasks</h2>
            <p class="subtext">
                <span id="activeTaskCount">{{ active_count }}</span> active tasks
            </p>
        </div>
        <a href="#" class="btn-primary" id="openAddBtn">
            <i class="fa fa-plus"></i> Add new task
        </a>
    </div>

    <!-- FILTERS -->
    <div class="filters">
        <form method="GET" id="filterForm">
            <select name="sort" onchange="this.form.submit()">
                <option value="default" {% if request.GET.sort == 'default' or not request.GET.sort %}selected{% endif %}>Default</option>
                <option value="priority" {% if request.GET.sort == 'priority' %}selected{% endif %}>Priority</option>
            </select>

            <select name="category" onchange="this.form.submit()">
                <option value="" {% if not request.GET.category %}selected{% endif %}>All Categories</option>
                <option value="School" {% if request.GET.category == 'School' %}selected{% endif %}>School</option>
                <option value="Personal" {% if request.GET.category == 'Personal' %}selected{% endif %}>Personal</option>
                <option value="Work" {% if request.GET.category == 'Work' %}selected{% endif %}>Work</option>
            </select>

            <select name="difficulty" onchange="this.form.submit()">
                <option value="" {% if not request.GET.difficulty %}selected{% endif %}>All Difficulty</option>
                <option value="Easy" {% if request.GET.difficulty == 'Easy' %}selected{% endif %}>Easy</option>
                <option value="Medium" {% if request.GET.difficulty == 'Medium' %}selected{% endif %}>Medium</option>
                <option value="Hard" {% if request.GET.difficulty == 'Hard' %}selected{% endif %}>Hard</option>
            </select>
        </form>
    </div>

    <!-- TASK LIST -->
    <div class="task-list">
        <div id="active-tasks">
            {% for task in tasks %}
                {% if not task.completed %}
                    {% include "main/partials/task_card.html" with task=task %}
                {% endif %}
            {% endfor %}
        </div>

        <h3 class="completed-title">Completed Tasks</h3>
        <div id="completed-tasks">
            {% for task in tasks %}
                {% if task.completed %}
                    {% include "main/partials/task_card.html" with task=task %}
                {% endif %}
            {% endfor %}
        </div>
    </div>
</div>

<!-- ADD TASK MODAL -->
<div id="addModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Add New Task</h2>

        <form id="addTaskForm" method="POST" action="{% url 'add_task' %}">
            {% csrf_token %}

            <label>Task Title</label>
            <input type="text" name="title" required>

            <label>Category</label>
            <select name="category" required>
                <option value="School">School</option>
                <option value="Personal">Personal</option>
                <option value="Work">Work</option>
            </select>

            <label>Difficulty</label>
            <select name="difficulty" required>
                <option value="Easy">Easy</option>
                <option value="Medium">Medium</option>
                <option value="Hard">Hard</option>
            </select>

            <label>Due Date</label>
            <input type="text" name="due_date" id="due_date" class="flatpickr">

            <label>Priority</label>
            <select name="priority">
                <option value="0">Low</option>
                <option value="1">Medium</option>
                <option value="2">High</option>
            </select>

            <button class="btn-primary">Add Task</button>
        </form>
    </div>
</div>

<!-- EDIT MODAL -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Edit Task</h2>

        <form id="editTaskForm" method="POST">{% csrf_token %}
            <label>Task Title</label>
            <input type="text" id="edit_title" name="title" required>

            <label>Category</label>
            <select id="edit_category" name="category" required>
                <option value="School">School</option>
                <option value="Personal">Personal</option>
                <option value="Work">Work</option>
            </select>

            <label>Difficulty</label>
            <select id="edit_difficulty" name="difficulty" required>
                <option value="Easy">Easy</option>
                <option value="Medium">Medium</option>
                <option value="Hard">Hard</option>
            </select>

            <label>Due Date</label>
            <input type="text" id="edit_due_date" name="due_date" class="flatpickr">

            <label>Priority</label>
            <select id="edit_priority" name="priority">
                <option value="0">Low</option>
                <option value="1">Medium</option>
                <option value="2">High</option>
            </select>

            <button class="btn-primary">Save Changes</button>
        </form>
    </div>
</div>

<!-- LOGOUT MODAL -->
<div id="logoutModal" class="modal">
    <div class="modal-content logout-box">
        <h2>Goodbye 👋</h2>
        <p>Are you sure you want to log out?</p>

        <button id="btnConfirmLogout" class="btn-danger">Logout</button>
        <button id="btnCancelLogout" class="btn-secondary">Stay logged in</button>
    </div>
</div>

<script>

/* ----------------------
   COOKIE HELPER
---------------------- */
function getCookie(name){
    let value = null;
    document.cookie.split(";").forEach(c=>{
        c = c.trim();
        if (c.startsWith(name + "="))
            value = decodeURIComponent(c.substring(name.length + 1));
    });
    return value;
}

/* ----------------------
   COUNTERS + SORT
---------------------- */
function refreshActiveCount(){
    const count = document.querySelectorAll("#active-tasks .task-card").length;
    document.getElementById("activeTaskCount").textContent = count;
}

function sortTasksByPriority(){
    const container = document.getElementById("active-tasks");
    if (!container) return;

    [...container.children]
        .sort((a,b)=> Number(b.dataset.priority) - Number(a.dataset.priority))
        .forEach(x => container.appendChild(x));
}

/* ----------------------
   FLATPICKR
---------------------- */
let addCalendar, editCalendar;

document.addEventListener("DOMContentLoaded", ()=>{

    addCalendar = flatpickr("#due_date", {
        minDate: "today",
        dateFormat: "Y-m-d"
    });

    editCalendar = flatpickr("#edit_due_date", {
        minDate: "today",
        dateFormat: "Y-m-d"
    });

    attachTaskEvents();
    refreshActiveCount();
    sortTasksByPriority();
});

/* ----------------------
   EDIT MODAL
---------------------- */
function openEditModal(btn){
    const id = btn.dataset.id;

    document.getElementById("edit_title").value       = btn.dataset.title;
    document.getElementById("edit_category").value    = btn.dataset.category;
    document.getElementById("edit_difficulty").value  = btn.dataset.difficulty;
    document.getElementById("edit_priority").value    = btn.dataset.priority;

    if (editCalendar)
        editCalendar.setDate(btn.dataset.due || "");

    document.getElementById("editTaskForm").action = `/tasks/edit/${id}/`;
    document.getElementById("editModal").style.display = "block";
}

/* ----------------------
   SUBTASK FUNCTIONS
---------------------- */
function addSubtask(taskId, title, inputEl){
    const fd = new FormData();
    fd.append("title", title);

    fetch(`/tasks/${taskId}/subtasks/add/`, {
        method: "POST",
        body: fd,
        headers:{
            "X-CSRFToken": getCookie("csrftoken"),
            "X-Requested-With": "XMLHttpRequest"
        }
    })
    .then(r => r.json())
    .then(data =>{
        if (!data.success) return;

        const list = document.querySelector(`.subtask-list[data-task-id="${taskId}"]`);
        if (!list) return;

        const li = document.createElement("li");
        li.className = "subtask-item";
        li.dataset.subtaskId = data.subtask_id;

        li.innerHTML = `
            <label class="subtask-checkbox">
                <input type="checkbox" data-subtask-id="${data.subtask_id}">
                <span class="subtask-title">${data.title}</span>
            </label>
            <button class="subtask-delete-btn" data-subtask-id="${data.subtask_id}">
                <i class="fa fa-times"></i>
            </button>
        `;

        list.appendChild(li);

        li.querySelector(".subtask-delete-btn").onclick = () =>
            deleteSubtask(data.subtask_id, li.querySelector(".subtask-delete-btn"));

        inputEl.value = "";
        updateSubtaskProgress(taskId, data.progress);

        attachTaskEvents(); // rebind new events
    });
}

function toggleSubtask(subtaskId, checkbox){
    fetch(`/subtasks/${subtaskId}/toggle/`, {
        method: "POST",
        headers:{
            "X-CSRFToken": getCookie("csrftoken"),
            "X-Requested-With": "XMLHttpRequest"
        }
    })
    .then(r=>r.json())
    .then(data=>{
        if (!data.success) return;

        const li = checkbox.closest(".subtask-item");
        li.classList.toggle("completed", data.completed);
        li.querySelector(".subtask-title").classList.toggle("crossed", data.completed);

        updateSubtaskProgress(
            checkbox.closest(".task-card").dataset.id,
            data.progress
        );
    });
}

function deleteSubtask(subtaskId, btn){
    fetch(`/subtasks/${subtaskId}/delete/`, {
        method:"POST",
        headers:{ 
            "X-CSRFToken": getCookie("csrftoken"),
            "X-Requested-With": "XMLHttpRequest"
        }
    })
    .then(res => res.json())
    .then(data => {
        if (!data.success) return;

        const li = btn.closest(".subtask-item");
        const taskId = btn.closest(".task-card").dataset.id;

        li.remove();
        updateSubtaskProgress(taskId, data.progress);
    });
}


function updateSubtaskProgress(taskId, progress){
    const bar   = document.querySelector(`.subtask-progress-fill[data-task-id="${taskId}"]`);
    const text  = document.querySelector(`.subtask-progress-text[data-task-id="${taskId}"]`);
    const badge = document.querySelector(`.subtask-count[data-task-id="${taskId}"]`);

    if (bar) bar.style.width = `${progress.percent}%`;
    if (text) text.textContent = `${progress.completed}/${progress.total} completed`;
    if (badge) badge.textContent = `${progress.completed}/${progress.total}`;
}

/* ----------------------
   MAIN EVENT BINDER
---------------------- */
function attachTaskEvents(){

    /* EDIT */
    document.querySelectorAll(".edit-btn").forEach(btn=>{
        btn.onclick = e=>{
            e.preventDefault();
            openEditModal(btn);
        };
    });

/* COMPLETE + DELETE */
document.querySelectorAll(".complete-btn, .delete-btn").forEach(btn => {
    btn.onclick = e => {
        e.preventDefault();

        const id = btn.dataset.id;
        const isCompleteBtn = btn.classList.contains("complete-btn");

        fetch(isCompleteBtn ? `/tasks/toggle_complete/${id}/` : `/tasks/delete/${id}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": getCookie("csrftoken"),
                "X-Requested-With": "XMLHttpRequest"
            }
        })
        .then(r => r.json())
        .then(data => {
            if (!data.success) return;

            const card = document.querySelector(`.task-card[data-id="${id}"]`);

            /* DELETE TASK */
            if (!isCompleteBtn) {
                card.remove();
                refreshActiveCount();
                return;
            }

            /* COMPLETE BUTTON CLICKED */
            const circle = card.querySelector(".circle");
            const checkIcon = circle.querySelector("i");

            /* GET ALL SUBTASKS */
            const subtasks = card.querySelectorAll(".subtask-item");
            const total = subtasks.length;

            if (data.completed) {
                /* ================================
                   TASK → COMPLETED
                ================================= */
                document.getElementById("completed-tasks").appendChild(card);
                card.classList.add("completed");
                card.querySelector(".task-title").classList.add("crossed");

                /* Circle UI */
                circle.classList.add("checked");
                checkIcon.style.display = "block";

                /* Change button icon (check → undo) */
                btn.querySelector("i").classList.replace("fa-check", "fa-undo");

                /* Mark all subtasks complete */
                subtasks.forEach(item => {
                    item.classList.add("completed");
                    item.querySelector(".subtask-title").classList.add("crossed");

                    const cb = item.querySelector("input[type='checkbox']");
                    cb.checked = true;
                    cb.disabled = true;

                    const delBtn = item.querySelector(".subtask-delete-btn");
                    if (delBtn) delBtn.disabled = true;
                });

                /* UPDATE PROGRESS TO 100% */
                updateSubtaskProgress(id, {
                    completed: total,
                    total: total,
                    percent: 100
                });

            } else {
                /* ================================
                   TASK → BACK TO ACTIVE
                ================================= */
                document.getElementById("active-tasks").appendChild(card);
                card.classList.remove("completed");
                card.querySelector(".task-title").classList.remove("crossed");

                /* Circle UI */
                circle.classList.remove("checked");
                checkIcon.style.display = "none";

                /* Undo → check */
                btn.querySelector("i").classList.replace("fa-undo", "fa-check");

                sortTasksByPriority();

                /* Reset subtask status */
                subtasks.forEach(item => {
                    item.classList.remove("completed");
                    item.querySelector(".subtask-title").classList.remove("crossed");

                    const cb = item.querySelector("input[type='checkbox']");
                    cb.checked = false;
                    cb.disabled = false;

                    const delBtn = item.querySelector(".subtask-delete-btn");
                    if (delBtn) delBtn.disabled = false;
                });

                /* RESET PROGRESS TO 0% */
                updateSubtaskProgress(id, {
                    completed: 0,
                    total: total,
                    percent: 0
                });
            }

            refreshActiveCount();
        });
    };
});

function toggleTaskComplete(id, sourceBtnOrCircle) {

    fetch(`/tasks/toggle_complete/${id}/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": getCookie("csrftoken"),
            "X-Requested-With": "XMLHttpRequest"
        }
    })
    .then(r => r.json())
    .then(data => {
        if (!data.success) return;

        const card = document.querySelector(`.task-card[data-id="${id}"]`);
        const circle = card.querySelector(".circle");
        const checkIcon = circle.querySelector("i");
        const completeBtnIcon = card.querySelector(".complete-btn i");
        const subtasks = card.querySelectorAll(".subtask-item");
        const total = subtasks.length;

        if (data.completed) {
            /* Move to completed section */
            document.getElementById("completed-tasks").appendChild(card);
            card.classList.add("completed");
            card.querySelector(".task-title").classList.add("crossed");

            /* Circle → green */
            circle.classList.add("checked");
            checkIcon.style.display = "block";

            /* Change button icon */
            completeBtnIcon.classList.replace("fa-check", "fa-undo");

            /* Complete subtasks */
            subtasks.forEach(item => {
                item.classList.add("completed");
                item.querySelector(".subtask-title").classList.add("crossed");

                const cb = item.querySelector("input[type='checkbox']");
                cb.checked = true;
                cb.disabled = true;

                const delBtn = item.querySelector(".subtask-delete-btn");
                if (delBtn) delBtn.disabled = true;
            });

            /* Update progress to 100% */
            updateSubtaskProgress(id, {
                completed: total,
                total: total,
                percent: 100
            });

        } else {
            /* Move back to active tasks */
            document.getElementById("active-tasks").appendChild(card);
            card.classList.remove("completed");
            card.querySelector(".task-title").classList.remove("crossed");

            /* Reset circle */
            circle.classList.remove("checked");
            checkIcon.style.display = "none";

            /* Undo → check */
            completeBtnIcon.classList.replace("fa-undo", "fa-check");

            sortTasksByPriority();

            /* Reset subtasks */
            subtasks.forEach(item => {
                item.classList.remove("completed");
                item.querySelector(".subtask-title").classList.remove("crossed");

                const cb = item.querySelector("input[type='checkbox']");
                cb.checked = false;
                cb.disabled = false;

                const delBtn = item.querySelector(".subtask-delete-btn");
                if (delBtn) delBtn.disabled = false;
            });

            /* Update progress to 0% */
            updateSubtaskProgress(id, {
                completed: 0,
                total: total,
                percent: 0
            });
        }

        refreshActiveCount();
    });
}





    /* FAVORITE */
    document.querySelectorAll(".favorite-btn").forEach(btn=>{
        btn.onclick = e=>{
            e.preventDefault();

            fetch(`/tasks/toggle_favorite/${btn.dataset.id}/`, {
                method:"POST",
                headers:{
                    "X-CSRFToken": getCookie("csrftoken"),
                    "X-Requested-With":"XMLHttpRequest"
                }
            })
            .then(r=>r.json())
            .then(data=>{
                if (data.success){
                    btn.querySelector("i").classList.toggle("starred", data.favorite);
                }
            });
        };
    });

    /* SUBTASK TOGGLE */
    document.querySelectorAll(".subtask-toggle-btn").forEach(btn=>{
        btn.onclick = e=>{
            e.preventDefault();

            const section = btn.closest(".task-card").querySelector(".subtasks-section");
            section.style.display = section.style.display === "none" ? "block" : "none";
        };
    });

    /* ADD SUBTASK (blocked if task completed) */
document.querySelectorAll(".add-subtask-btn").forEach(btn => {
    btn.onclick = () => {
        const taskCard = btn.closest(".task-card");

        if (taskCard.classList.contains("completed")) {
            // Optional visual feedback
            btn.style.opacity = "0.5";
            btn.style.cursor = "not-allowed";
            return;
        }

        const input = taskCard.querySelector(".subtask-input");
        const text = input.value.trim();
        if (text) addSubtask(btn.dataset.taskId, text, input);
    };
});



   /* ENTER → ADD SUBTASK (blocked if completed) */
document.querySelectorAll(".subtask-input").forEach(input => {
    input.onkeypress = e => {
        if (e.key === "Enter") {
            e.preventDefault();

            const taskCard = input.closest(".task-card");

            if (taskCard.classList.contains("completed")) {
                input.blur();
                return;
            }

            const text = input.value.trim();
            if (text) addSubtask(input.dataset.taskId, text, input);
        }
    };
});




 /* CHECK SUBTASK (blocked if task completed) */
document.querySelectorAll(".subtask-checkbox input").forEach(box => {
    box.onchange = () => {

        const taskCard = box.closest(".task-card");
        if (taskCard.classList.contains("completed")) {
            box.checked = !box.checked;  // revert toggle
            return;
        }

        toggleSubtask(box.dataset.subtaskId, box);
    };
});



/* DELETE SUBTASK (blocked if task completed) */
document.querySelectorAll(".subtask-delete-btn").forEach(btn => {
    btn.onclick = e => {
        e.preventDefault();

        const taskCard = btn.closest(".task-card");
        if (taskCard.classList.contains("completed")) {
            return; // block delete
        }

        deleteSubtask(btn.dataset.subtaskId, btn);
    };
});



       /* CLICKABLE CIRCLE TO TOGGLE COMPLETE */
    document.querySelectorAll(".circle").forEach(circle => {
        circle.onclick = e => {
            e.preventDefault();
            toggleTaskComplete(circle.dataset.id, circle);
        };
    });




}

/* ----------------------
   MODALS
---------------------- */
document.getElementById("openAddBtn").onclick = e=>{
    e.preventDefault();
    document.getElementById("addModal").style.display = "block";
};

document.querySelectorAll(".modal .close").forEach(btn=>{
    btn.onclick = ()=> btn.closest(".modal").style.display = "none";
});

document.getElementById("openLogout").onclick = e=>{
    e.preventDefault();
    document.getElementById("logoutModal").style.display = "block";
};

document.getElementById("btnCancelLogout").onclick = ()=>{
    document.getElementById("logoutModal").style.display = "none";
};

window.onclick = e=>{
    if (e.target.classList.contains("modal"))
        e.target.style.display = "none";
};

/* ----------------------
   EDIT FORM (AJAX)
---------------------- */
document.getElementById("editTaskForm").onsubmit = function(e){
    e.preventDefault();

    fetch(this.action, {
        method:"POST",
        headers:{
            "X-CSRFToken": getCookie("csrftoken"),
            "X-Requested-With":"XMLHttpRequest"
        },
        body: new FormData(this)
    })
    .then(r=>r.json())
    .then(data=>{
        if (data.success){
            location.reload();
        } else {
            alert("Error updating task.");
        }
    });
};

</script>


</body>
</html>
